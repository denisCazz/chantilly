---
---

<script>
const scheduleNonCriticalWork = (callback) => {
  if ('requestIdleCallback' in window) {
    window.requestIdleCallback(callback, { timeout: 2000 });
  } else {
    setTimeout(callback, 180);
  }
};

const initEnhancements = () => {
  const body = document.body;
  if (!body) return;

  const scrollToTopBtn = document.createElement('button');
  scrollToTopBtn.innerHTML = 'â†‘';
  scrollToTopBtn.className = 'scroll-to-top';
  scrollToTopBtn.setAttribute('aria-label', 'Torna in cima');
  scrollToTopBtn.style.cssText = `
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: var(--color-primary);
    color: var(--color-white);
    border: 1px solid var(--color-border);
    font-size: 1.2rem;
    cursor: pointer;
    box-shadow: 0 16px 38px rgba(140, 75, 29, 0.2);
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
    z-index: 1000;
  `;

  body.appendChild(scrollToTopBtn);

  const updateScrollButtonVisibility = () => {
    if (window.scrollY > 300) {
      scrollToTopBtn.style.opacity = '1';
      scrollToTopBtn.style.visibility = 'visible';
    } else {
      scrollToTopBtn.style.opacity = '0';
      scrollToTopBtn.style.visibility = 'hidden';
    }
  };

  window.addEventListener('scroll', updateScrollButtonVisibility, { passive: true });

  scrollToTopBtn.addEventListener('click', () => {
    window.scrollTo({ top: 0, behavior: 'smooth' });
  });

  scrollToTopBtn.addEventListener('mouseenter', () => {
    scrollToTopBtn.style.background = 'var(--color-secondary)';
    scrollToTopBtn.style.transform = 'translateY(-2px)';
  });

  scrollToTopBtn.addEventListener('mouseleave', () => {
    scrollToTopBtn.style.background = 'var(--color-primary)';
    scrollToTopBtn.style.transform = 'translateY(0)';
  });

  const observerOptions = {
    threshold: 0.1,
    rootMargin: '0px 0px -50px 0px'
  };

  const observer = 'IntersectionObserver' in window
    ? new IntersectionObserver((entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting && entry.target instanceof HTMLElement) {
            entry.target.style.opacity = '1';
            entry.target.style.transform = 'translateY(0)';
          }
        });
      }, observerOptions)
    : null;

  const animatedElements = document.querySelectorAll('.service-card, .review-card, .info-item, .feature');

  animatedElements.forEach((node) => {
    if (!(node instanceof HTMLElement)) return;
    node.style.opacity = '0';
    node.style.transform = 'translateY(30px)';
    node.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
    if (observer) {
      observer.observe(node);
    } else {
      requestAnimationFrame(() => {
        node.style.opacity = '1';
        node.style.transform = 'translateY(0)';
      });
    }
  });

  updateScrollButtonVisibility();
};

const kickoffEnhancements = () => {
  scheduleNonCriticalWork(initEnhancements);
};

if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', kickoffEnhancements, { once: true });
} else {
  kickoffEnhancements();
}

document.addEventListener('keydown', (event) => {
  if (event.key !== 'Escape') return;
  const navMenu = document.getElementById('nav-menu');
  const mobileToggle = document.getElementById('mobile-toggle');
  if (navMenu) navMenu.classList.remove('active');
  if (mobileToggle) mobileToggle.classList.remove('active');
});

if (window.matchMedia && window.matchMedia('(prefers-contrast: high)').matches) {
  document.documentElement.classList.add('high-contrast');
}

if (window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
  document.documentElement.classList.add('reduced-motion');
}
</script>

<style>
.high-contrast {
  --color-primary: #000000 !important;
  --color-text: #000000 !important;
  --color-white: #ffffff !important;
  --shadow: 0 2px 8px rgba(0, 0, 0, 0.5) !important;
}

.reduced-motion * {
  animation-duration: 0.01ms !important;
  animation-iteration-count: 1 !important;
  transition-duration: 0.01ms !important;
  scroll-behavior: auto !important;
}

*:focus-visible {
  outline: 2px solid #1a1a1a;
  outline-offset: 2px;
  border-radius: 4px;
}

button:focus-visible,
a:focus-visible {
  outline: 2px solid #1a1a1a;
  outline-offset: 2px;
}
</style>
