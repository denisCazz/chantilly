<script is:inline>
	// Inizializza il tema immediatamente per prevenire il flash
	(function() {
		const storageKey = 'theme';
		const LIGHT = 'light';
		const DARK = 'dark';
		const SYSTEM = 'system';
		const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');

		const storage = {
			get() {
				try {
					return localStorage.getItem(storageKey);
				} catch {
					return null;
				}
			}
		};

		const sanitizeMode = (value) => (value === LIGHT || value === DARK || value === SYSTEM ? value : null);
		const effectiveThemeFor = (mode) => (mode === DARK || mode === LIGHT ? mode : (mediaQuery.matches ? DARK : LIGHT));

		const applyTheme = (mode) => {
			const safeMode = sanitizeMode(mode) ?? SYSTEM;
			const effectiveTheme = effectiveThemeFor(safeMode);
			[document.documentElement, document.body].filter(Boolean).forEach((node) => {
				node.setAttribute('data-theme', effectiveTheme);
				node.setAttribute('data-theme-mode', safeMode);
			});
		};

		const storedMode = sanitizeMode(storage.get());
		const initialMode = storedMode ?? SYSTEM;
		applyTheme(initialMode);

		const handleSystemChange = () => {
			const currentMode = sanitizeMode(storage.get()) ?? SYSTEM;
			if (currentMode !== SYSTEM) return;
			applyTheme(SYSTEM);
		};

		if (typeof mediaQuery.addEventListener === 'function') {
			mediaQuery.addEventListener('change', handleSystemChange);
		} else if (typeof mediaQuery.addListener === 'function') {
			mediaQuery.addListener(handleSystemChange);
		}
	})();
</script>
